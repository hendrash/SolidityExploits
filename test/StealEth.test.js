const Web3 = require("web3");
const assert =require("assert")
const BuyANFT = require("../build/contracts/BuyANFT.json");
const NFTStore = require("../build/contracts/NFTStore.json");
const StealEth = require("../build/contracts/StealEth.json");

describe("Stealing eth", async () => {
  it("is there hiden malicious code", async () => {
    let web3 = new Web3("http://127.0.0.1:7545/");
    let id = await web3.eth.net.getId();
    this.BuyANFTAddress = BuyANFT.networks[id];
    this.NFTStoreAddress = NFTStore.networks[id];
    this.StealEthAddress = StealEth.networks[id];
    const [alice] = await web3.eth.getAccounts();

    nftStore = new web3.eth.Contract(
      NFTStore.abi,
      this.NFTStoreAddress.address
    );
    buyNFT = new web3.eth.Contract(BuyANFT.abi, this.BuyANFTAddress.address);
    stealEth = new web3.eth.Contract(
      StealEth.abi,
      this.StealEthAddress.address
    );

    await nftStore.methods.buy().send({
      from: alice,
      value: web3.utils.toWei("2", "ether"),
    });
    let balance = await stealEth.methods.getBalance().call();
    console.log("Hackers balance: "+web3.utils.fromWei(balance, "ether") + " ether");
    balance = await buyNFT.methods.getBalance().call();
    console.log("NTF Store balance: "+web3.utils.fromWei(balance, "ether") + " ether");
    assert(
      balance == 0,
      "The balance of buyNFT never increases so our eth is ever getting to it"
    );
  });
});
